<div class="search-filter-container" (click)="closeDropdowns()"> 
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="search-form">
    
    <div class="filters-premium">
      
      <!-- ✅ BARRA DE BÚSQUEDA DE TEXTO AGREGADA -->
      <div class="search-main">
        <div class="search-box-premium">
          <div class="search-icon-wrapper">
            <svg class="search-icon-animated" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </div>
          <input 
            type="text" 
            formControlName="q" 
            class="search-input-premium" 
            placeholder="Buscar por ubicación, título, descripción..."
          />
        </div>
        <button type="submit" class="btn-search-inline" [disabled]="isLoading">
          @if (isLoading) {
            <div class="spinner-premium"></div>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          }
          <span>Buscar</span>
        </button>
      </div>

      <div class="quick-filters">
        
        <div class="filter-chip">
          <label class="chip-label">Tipo</label>
          <select formControlName="tipo_propiedad_id" class="chip-select">
            <option value="">Todos</option>
            @for (tipo of tiposPropiedad; track tipo.id) {
              <option [value]="tipo.id">{{ tipo.nombre }}</option>
            }
          </select>
        </div>

        <div class="filter-chip custom-dropdown-container">
          <label class="chip-label">Estado</label>
          <input 
            type="text"
            formControlName="estadoSearchText"
            class="chip-select"
            placeholder="Escribe un estado..."
            (focus)="showEstadosDropdown = true"
            (click)="$event.stopPropagation()" 
          />
          @if (showEstadosDropdown) {
            <ul class="custom-dropdown-list" (click)="$event.stopPropagation()">
              @for (estado of estadosFiltrados; track estado.id) {
                <li (click)="selectEstado(estado)">{{ estado.nombre }}</li>
              }
              @if (estadosFiltrados.length === 0) {
                <li class="disabled">Sin resultados</li>
              }
            </ul>
          }
        </div>

        <div class="filter-chip custom-dropdown-container">
          <label class="chip-label">Ciudad</label>
          <input 
            type="text"
            formControlName="ciudadSearchText"
            class="chip-select"
            placeholder="Escribe una ciudad..."
            [disabled]="!form.get('estado_id')?.value"
            (focus)="showCiudadesDropdown = true"
            (click)="$event.stopPropagation()"
          />
          @if (showCiudadesDropdown) {
            <ul class="custom-dropdown-list" (click)="$event.stopPropagation()">
              @for (ciudad of ciudadesFiltradasPorBusqueda; track ciudad.id) {
                <li (click)="selectCiudad(ciudad)">{{ ciudad.nombre }}</li>
              }
              @if (ciudadesFiltradasPorBusqueda.length === 0) {
                <li class="disabled">Sin resultados</li>
              }
            </ul>
          }
        </div>

        <!-- ✅ BOTÓN DE MÁS FILTROS CORREGIDO -->
        <button 
          type="button" 
          (click)="toggleAdvancedFilters()"
          class="filter-chip filter-chip-button"
          [class.active]="showAdvancedFilters || hasActiveFilters()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="4" y1="10" x2="4" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="3"></line>
            <line x1="20" y1="21" x2="20" y2="16"></line>
            <line x1="20" y1="12" x2="20" y2="3"></line>
            <line x1="1" y1="14" x2="7" y2="14"></line>
            <line x1="9" y1="8" x2="15" y2="8"></line>
            <line x1="17" y1="16" x2="23" y2="16"></line>
          </svg>
          <span class="chip-text">Más filtros</span>
          @if (hasActiveFilters()) {
            <span class="chip-badge">{{ activeFiltersCount() }}</span>
          }
        </button>
      </div>
    </div>

    <!-- Panel expandible de filtros avanzados -->
    @if (showAdvancedFilters) {
      <div class="advanced-modal">
        
        <div class="modal-header">
          <div class="modal-title-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            <h3>Filtros Avanzados</h3>
          </div>
          <button 
            type="button" 
            (click)="toggleAdvancedFilters()"
            class="btn-close-modal"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          
          <!-- Precio -->
          <div class="filter-section">
            <h4 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
              </svg>
              Precio
            </h4>
            <div class="section-grid">
              <div class="form-field">
                <label>Desde</label>
                <input 
                  type="number" 
                  formControlName="minPrice" 
                  placeholder="$0"
                  class="field-input"
                  step="10000"
                />
              </div>
              <div class="form-field">
                <label>Hasta</label>
                <input 
                  type="number" 
                  formControlName="maxPrice" 
                  placeholder="Sin límite"
                  class="field-input"
                  step="10000"
                />
              </div>
            </div>
          </div>

          <!-- Características -->
          <div class="filter-section">
            <h4 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
              </svg>
              Características
            </h4>
            <div class="section-grid-three">
              <div class="form-field">
                <label>Habitaciones</label>
                <input 
                  type="number" 
                  formControlName="habitaciones" 
                  placeholder="Min."
                  class="field-input"
                  min="0"
                />
              </div>
              <div class="form-field">
                <label>Baños</label>
                <input 
                  type="number" 
                  formControlName="banos" 
                  placeholder="Min."
                  class="field-input"
                  min="0"
                />
              </div>
              <div class="form-field">
                <label>Estacionamientos</label>
                <input 
                  type="number" 
                  formControlName="estacionamientos" 
                  placeholder="Min."
                  class="field-input"
                  min="0"
                />
              </div>
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" (click)="onReset()" class="btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="1 4 1 10 7 10"></polyline>
              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
            Limpiar
          </button>
          <button type="button" class="btn-primary" (click)="toggleAdvancedFilters()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Aplicar
          </button>
        </div>

      </div>
    }

  </form>
</div>