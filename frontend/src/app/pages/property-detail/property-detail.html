<div class="container">
  <!-- Loading State -->
  @if (loading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando propiedad...</p>
    </div>
  }

  <!-- Property Content -->
  @if (data && !loading) {
    <div class="property-detail">
      <!-- Back Button -->
      <a routerLink="/propiedades" class="back">
        ← Volver a propiedades
      </a>

      <!-- Header Section -->
      <div class="header">
        <div class="title-section">
          <span class="badge">{{ tipoNegocio }}</span>
          <h1>{{ data.titulo }}</h1>
          <div class="meta">
            @if (data.direccion) {
              <span>📍 {{ data.direccion }}</span>
            }
            @if (data['colonia']) {
              <span>{{ data['colonia'] }}</span>
            }
            @if (data.codigo_postal) {
              <span>CP: {{ data.codigo_postal }}</span>
            }
          </div>
        </div>
        <div class="price-section">
          @if (displayPrice) {
            <div class="price">
              {{ displayPrice | currency:'MXN':'symbol':'1.0-0' }}
            </div>
          }
          @if (data.valor_administracion) {
            <div class="price-details">
              <small>+ Administración: {{ data.valor_administracion | currency:'MXN':'symbol':'1.0-0' }}</small>
            </div>
          }
        </div>
      </div>

      <!-- Image Gallery Mejorada -->
      @if (images.length > 0) {
        <div class="gallery-container">
          <div class="main-gallery">
            <img [src]="images[currentImageIndex]" [alt]="data.titulo || 'Propiedad'" class="main-image" />
            @if (images.length > 1) {
              <button class="nav-arrow prev" (click)="prevImage()" title="Imagen anterior">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <button class="nav-arrow next" (click)="nextImage()" title="Imagen siguiente">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
              <div class="image-counter">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <path d="M21 15l-5-5L5 21"/>
                </svg>
                {{ currentImageIndex + 1 }} / {{ images.length }}
              </div>
            }
          </div>
          
          <!-- Thumbnails (miniaturas para navegar) -->
          @if (images.length > 1) {
            <div class="thumbnails">
              @for (image of images; track $index) {
                <button 
                  class="thumbnail" 
                  [class.active]="currentImageIndex === $index"
                  (click)="currentImageIndex = $index">
                  <img [src]="image" [alt]="'Imagen ' + ($index + 1)" />
                </button>
              }
            </div>
          }
        </div>
      }

      <!-- Quick Facts -->
      <div class="quick-facts">
        @if (data.habitaciones) {
          <div class="fact-item">
            <span class="icon">🛏️</span>
            <div>
              <strong>{{ data.habitaciones }}</strong>
              <small>Habitaciones</small>
            </div>
          </div>
        }
        @if (data.alcobas) {
          <div class="fact-item">
            <span class="icon">🚪</span>
            <div>
              <strong>{{ data.alcobas }}</strong>
              <small>Alcobas</small>
            </div>
          </div>
        }
        @if (data.banos) {
          <div class="fact-item">
            <span class="icon">🚿</span>
            <div>
              <strong>{{ data.banos }}</strong>
              <small>Baños</small>
            </div>
          </div>
        }
        @if (data.banos_medios) {
          <div class="fact-item">
            <span class="icon">🚽</span>
            <div>
              <strong>{{ data.banos_medios }}</strong>
              <small>Medios Baños</small>
            </div>
          </div>
        }
        @if (data.estacionamientos) {
          <div class="fact-item">
            <span class="icon">🚗</span>
            <div>
              <strong>{{ data.estacionamientos }}</strong>
              <small>Estacionamientos</small>
            </div>
          </div>
        }
        @if (data.m2_construccion) {
          <div class="fact-item">
            <span class="icon">📐</span>
            <div>
              <strong>{{ data.m2_construccion }} m²</strong>
              <small>Construcción</small>
            </div>
          </div>
        }
      </div>

      <!-- Action Buttons Mejorados -->
      <div class="actions">
        <button class="btn btn-primary" (click)="contactarWhatsApp()">
          <span class="icon">💬</span> 
          <span>Contactar por WhatsApp</span>
        </button>
        @if (data.lat && data.lng) {
          <button class="btn btn-secondary" (click)="verEnGoogleMaps()">
            <span class="icon">📍</span> 
            <span>Ver en Mapa</span>
          </button>
        }
        <button class="btn btn-outline" (click)="compartir()">
          <span class="icon">🔗</span> 
          <span>Compartir</span>
        </button>
      </div>

      <!-- Description Section -->
      @if (data.descripcion) {
        <section class="section">
          <h2>Descripción</h2>
          <p class="description">{{ data.descripcion }}</p>
        </section>
      }

      <!-- Property Details -->
      <section class="section">
        <h2>Características de la Propiedad</h2>
        <div class="details-grid">
          @if (data.m2_terreno) {
            <div class="detail-item">
              <span class="label">Terreno</span>
              <span class="value">{{ data.m2_terreno }} m²</span>
            </div>
          }
          @if (data.m2_construccion) {
            <div class="detail-item">
              <span class="label">Construcción</span>
              <span class="value">{{ data.m2_construccion }} m²</span>
            </div>
          }
          @if (data.m2_privada) {
            <div class="detail-item">
              <span class="label">Área Privada</span>
              <span class="value">{{ data.m2_privada }} m²</span>
            </div>
          }
          @if (data.anio_construccion) {
            <div class="detail-item">
              <span class="label">Año de Construcción</span>
              <span class="value">{{ data.anio_construccion }}</span>
            </div>
          }
          @if (data.piso) {
            <div class="detail-item">
              <span class="label">Piso</span>
              <span class="value">{{ data.piso }}</span>
            </div>
          }
          @if (data.habitaciones) {
            <div class="detail-item">
              <span class="label">Habitaciones</span>
              <span class="value">{{ data.habitaciones }}</span>
            </div>
          }
          @if (data.alcobas) {
            <div class="detail-item">
              <span class="label">Alcobas</span>
              <span class="value">{{ data.alcobas }}</span>
            </div>
          }
          @if (data.banos) {
            <div class="detail-item">
              <span class="label">Baños Completos</span>
              <span class="value">{{ data.banos }}</span>
            </div>
          }
          @if (data.banos_medios) {
            <div class="detail-item">
              <span class="label">Medios Baños</span>
              <span class="value">{{ data.banos_medios }}</span>
            </div>
          }
          @if (data.estacionamientos) {
            <div class="detail-item">
              <span class="label">Estacionamientos</span>
              <span class="value">{{ data.estacionamientos }}</span>
            </div>
          }
        </div>
      </section>

      <!-- Location Section -->
      @if (data.direccion || data['colonia'] || data.codigo_postal) {
        <section class="section">
          <h2>Ubicación</h2>
          <div class="location-info">
            @if (data.direccion) {
              <p><strong>Dirección:</strong> {{ data.direccion }}</p>
            }
            @if (data['colonia']) {
              <p><strong>Colonia:</strong> {{ data['colonia'] }}</p>
            }
            @if (data.codigo_postal) {
              <p><strong>Código Postal:</strong> {{ data.codigo_postal }}</p>
            }
            @if (data.lat && data.lng) {
              <p><strong>Coordenadas:</strong> {{ data.lat }}, {{ data.lng }}</p>
            }
          </div>
        </section>
      }

      <!-- Legal Information -->
      @if (data.registro_publico || data.convenio_url) {
        <section class="section">
          <h2>Información Legal</h2>
          <div class="legal-info">
            @if (data.registro_publico) {
              <p><strong>Registro Público:</strong> {{ data.registro_publico }}</p>
            }
            @if (data.convenio_url) {
              <p>
                <strong>Convenio:</strong> 
                <a [href]="data.convenio_url" target="_blank" rel="noopener">Ver documento</a>
                @if (data.convenio_validado) {
                  <span class="badge-success">✓ Validado</span>
                }
              </p>
            }
          </div>
        </section>
      }

      <!-- Additional Info -->
      <section class="section info-footer">
        <p class="disclaimer">
          <small>Los precios y características están sujetos a cambios sin previo aviso. 
          Todos los datos proporcionados son aproximados y deben ser verificados.</small>
        </p>
      </section>
    </div>
  }

  <!-- Not Found State -->
  @if (!data && !loading) {
    <div class="not-found">
      <h2>Propiedad no encontrada</h2>
      <p>Lo sentimos, no pudimos encontrar la propiedad que buscas.</p>
      <a routerLink="/propiedades" class="btn btn-primary">Volver a propiedades</a>
    </div>
  }
</div>